<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/statics/ionicons/css/w3.css">
    <link rel="stylesheet" href="/statics/ionicons/css/ionicons.min.css">
    <title>Enterprise Notes</title>
    <style>
        .hoverbtn:hover {
            font-weight: bold;
            opacity: 0.4;
            font-size: 14px;
        }
        a {
            text-decoration: none;
        }
        .custom-textarea {
            border: 2px solid #000; 
            border-radius: 5px; 
            padding: 10px; 
        }
        .w3-table th, .w3-table td {
        min-width: 100px; 
        text-align: center; 
        }
        .hidden-td {
            display: none;
        }
        .highlight {
            background-color: yellow;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            width: 50%;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="w3-row-padding">
        <div class="w3-card-2 w3-margin-top">
            <header class="w3-container w3-center w3-teal">
                <div class="w3-row">
                    <div class="w3-half">
                        <h2 class="w3-right">Notes</h2>
                        <h3 class="w3-left-align">
                            User Name: {{.Username}}
                            <a href="javascript:void(0);" class="w3-button w3-round-large" onclick="document.getElementById('user-settings').style.display='block'">
                                <i class="ion-android-settings"></i>
                            </a>
                        </h3>
                    </div>
                    
                    <div class="w3-half w3-text-right">
                        <div class="w3-right">
                            <a href="#" onclick="document.getElementById('create-form').style.display='block'">
                                <i class="icon ion-ios-plus-outline w3-xxlarge hoverbtn"></i>
                            </a>
                            <a href="/logout">
                                <i class="icon ion-log-out w3-xxlarge hoverbtn"></i>
                            </a>
                        </div>
                    </div>
                </div>
                 <!-- search icon on the right-->
                 <div class="w3-text-left">
                    <div class="w3-left">
                     <form action="/searchnotes" method="get">
                        <input type="text" placeholder="Search.." name="searchfield">
                        <button class="icon ion-search w3-xxlarge hoverbtn" type="submit"></button>
                     </form>
                    </div>
                </div>
                <div class="w3-text-right">
                    <div class="w3-right">
                        <button class="w3-button w3-light-grey w3-padding-small w3-hover-red" onclick="opensharelist()">Create Sharing Lists</button>
                    </div>
                </div>
            </header>
               
        <table class="w3-table w3-centered w3-border w3-bordered w3-hoverable">
            <thead>
                <tr>
                    <th><a href="/list">Note ID:</a></th>
                    <th><a href="/list/2">Note by:</a></th>
                    <th><a href="/list/3">Note Title:</a></th>
                    <th><a href="/list/4">Date Created:</a></th>
                    <th><a href="/list/5">Delegated to:</a></th>
                    <th><a href="/list/6">Date Completed:</a></th>
                    <th><a href="/list/7">Status:</a></th>
                </tr>
            </thead>
            <tbody> 
                {{range $note := .Notes}}
                <tr>
                    <td>{{$note.NoteID}}</td>
                    <td>{{$note.Username}}</td>
                    <td>{{$note.NoteTitle}}</td>
                    <td>{{$note.CreationDateFormatted}}</td>
                    <td>{{$note.Delegation}}</td>
                    <td id="completiondate-main">{{$note.CompletionDateFormatted}}</td>
                    <td>{{$note.Status}}</td>
                    <td>
                        <button class="w3-button w3-light-grey w3-padding-small w3-hover-red" onclick="updateNote(this);" data-note-content="{{.NoteContent}}">Open</button>
                        <button class="w3-button w3-light-grey w3-padding-small w3-hover-red" onclick="deleteNote(this)">Delete</button> <!--needs to change to invisble or visable for the note owners-->
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
<!-- Sharing list modal-->
<div class="w3-container">
    <div id="sharinglistmodal" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-zoom" style="max-width: 600px;">
            <h3 class="w3-left-align">
                <a href="javascript:woid(0);" onclick="closesharelist()">&times;</a>
            </h3>
            <div class="w3-container w3-teal">
                <h2>Create Sharing List</h2>
            </div>

            <form class="w3-container" style="max-height: 2000px;" action="/createsharinglist" method="post">
                <label class="w3-label" style="font-size: large;">Name your Sharing list:</label>
                <input class="w3-input" id="listname" name="listname" value="" type="text">
                <label class="w3-label" style="font-size: large;">Enter the user(s) to share with:</label><br>
                <div id="user-share-create"></div>
                <button class="w3-btn w3-teal w3-margin-top w3-margin-bottom w3-right" type="submit">Create list</button>
            </form>
        </div>
    </div>
</div>
<!-- User Settings -->
<div class="w3-container">
    <div id="user-settings" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-zoom" style="max-width: 600px;">
            <!-- Head -->
            <h3 class="w3-left-align">
                <a href="javascript:void(0);" onclick="document.getElementById('user-settings').style.display='none'">&times;</a>
            </h3>
            <div class="w3-container w3-teal">
                <h2>Settings</h2>
                <p>Enter New User Name and Password</p>
            </div>

            <form class="w3-container" style="max-height: 2000px;" action="/updateUser" method="post">

                <label class="w3-label">User Name :</label>
                <input class="w3-input w3-border" name="newUsername" id="newUsername">
                <label class="w3-label">New Password :</label>
                <input class="w3-input w3-border" name="newPassword" id="newPassword">
                <label class="w3-label">Confirm New Password :</label>
                <input class="w3-input w3-border" name="confirmPassword">
                <button class="w3-btn w3-teal w3-margin-top w3-margin-bottom w3-right" type="submit">Update</button>
                
            </form>
            <form class="w3-container" action="/deleteUser" method="post">
                <input type="hidden" name="deleteUsername" value="{{.Username}}">
                <div class="w3-center">
                    <button class="w3-btn w3-red w3-margin-top w3-margin-bottom" type="submit">Delete Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Modals -->
<div class="w3-container">
    <div id="create-form" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-zoom" style="max-width: 600px;">
            <!-- head -->
            <div class="w3-container w3-teal">
                <h2>Create A Note</h2>
                <span class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                      onclick="document.getElementById('create-form').style.display='none'">&times;</span>
            </div>

            <form class="w3-container" action="/create" method="post">
                <label id="noteTitle" class="w3-label" style="font-size: large;">Note Title:</label>
                <input class="w3-input" type="text" name="NoteTitle" value="">

                <label id ="NoteContent" class="w3-label" style="font-size: large;">Note Content:</label>
                <textarea class="w3-input custom-textarea" type="text" rows="8" cols="50" name="NoteContent" value="" step=""></textarea>

                <label id="status"class="w3-label" style="font-size: large;">Status:</label>
                <select class="w3-input" name="status">
                    <option value="None">None</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>

                <label class="w3-label" style="font-size: large;" >Completion Date:</label>
                <input class="w3-input" type="datetime" name="CompletionDate" id ="date" value="">

                <label id="delegated" class="w3-label" style="font-size: large;">Delegated to:</label>
                <select class="w3-select" name="delegated" id="delegatedlist"><option value="">Please select</option></select>

                <button class="w3-btn w3-teal w3-margin-top w3-margin-bottom w3-right" type="submit">Create</button>
            </form>
        </div>
    </div>
</div>


<!-- Edit Modals -->
<div class="w3-container">
    <div id="edit-form" class="w3-modal">
        <div class="w3-modal-content w3-card-8 w3-animate-zoom" style="max-width: 600px;">
            <!-- head -->
            <div class="w3-container w3-teal">
                <div class="w3-panel">
                    <h5 class="w3-left-align highlightable"><span id="note-title-display"></span></h5>
                    <h5 class="w3-left-align highlightable"><span id="user-name-display"></span></h5>
                </div>
                <span class="w3-closebtn w3-black w3-hover-red w3-container w3-padding-8 w3-display-topright"
                      onclick="document.getElementById('edit-form').style.display='none'">&times;</span>
            </div>
            <form class="w3-right" name="searchinnote">
                <input type="hidden" id="noteIdToSearch" name="noteIdToSearch">
                <input type="text" placeholder="Search.." name="search">    
                <button class="icon ion-search w3-xxlarge hoverbtn" type="button" onclick="updateHighlighting()"></button>
            </form>
            <div class="w3-container">
                <form action="/update" method="post">
                    <input type="hidden" id="noteIdToUpdate" name="noteIdToUpdate">
                    <label id ="NoteContent" class="w3-label" style="font-size: large;">Note Content:</label>
                    <textarea class="w3-input custom-textarea highlightable" id="noteContentTextarea" type="text" rows="8" cols="50" name="NoteContent" value="" step=""></textarea>
                    <label class="w3-label">Created Date: <span class="highlightable" name="createDate" id="createDate-edit"></span></label>
                    <br>
                    <label class="w3-label">Status:</label>
                    <select class="w3-select highlightable" name="status" id="status-edit">
                        <option value="None">None</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <label class="w3-label">Delegated to:</label>
                    <select class="w3-select highlightable" name="delegated" id="delegatedlist-edit">
                    </select>                    
                    <label class="w3-label">Completion Date:</label>
                    <input class="w3-input w3-border highlightable" type="datetime-local" name="completiondate" id="completeDate-edit">
                    <button class="w3-btn w3-teal w3-margin-top w3-margin-left w3-right" type="submit">Save</button>
                </form>
                <button class="w3-btn w3-teal w3-margin-top w3-margin-bottom w3-right" onclick="openShareUserModal()">Share</button>
            </div>
            </div>
        </div>
    </div>
</div>      

<!-- for the share button -->
<div id="shareUserModal" class="w3-modal">
    <div class="w3-modal-content w3-card-4">
        <header class="w3-container w3-teal">
            <span class="w3-button w3-display-topright" onclick="closeShareUserModal()">&times;</span>
            <h2>Share User</h2>
        </header>
        <div class="w3-container">
            <form class="w3-container" action="/sharenote" method="post">
                <!-- Content of the modal dialog goes here -->
                <input type="hidden" id="noteIdToUpdate-Share" name="noteIdToUpdate-Share"></input>
                <label class="w3-label" style="font-size: large;">Enter the user(s) to share with:</label><br>
                <div id="user-shareoptions"></div>
                <br>
                <label class="w3-label" style="font-size: large;">and/or</label><br>
                <label class="w3-label" style="font-size: large;">Select custom sharing lists:</label><br>
                <div id="custom-list-shareoptions"></div>
                <br>
                <button class="w3-button w3-teal" type="submit">Share</button>
            </form>
        </div>
    </div>
</div>

    <!-- Delete Modals -->
    <div class="w3-container">
        <div id="delete-form" class="w3-modal">
            <div class="w3-modal-content w3-card-8 w3-animate-zoom" style="max-width: 600px;">
                <!-- head -->
                <div class="w3-container w3-teal">
                    <h2>Delete Note?</h2>
                    <span class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                        onclick="document.getElementById('delete-form').style.display='none'">&times;</span>
                </div>

                <form class="w3-container" action="/delete" method="post">
                    <input type="hidden" name="NoteId" id="NoteId">
                    <div class="w3-center">
                        <button class="w3-btn w3-red w3-margin-top w3-margin-bottom" type="submit">Delete</button>
                        <button type="button" class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                onclick="document.getElementById('delete-form').style.display='none'">Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
<script>
let noteIdToUpdate = null; // Initialize it as null initially

// Function to set the noteIdToUpdate value when it becomes available
function setNoteIdToUpdate(value) {
    noteIdToUpdate = value;
}
function updateNote(e) {
    var editForm = document.getElementById('edit-form');
    editForm.style.display = 'block';

    // Get the note information from the current row
    var noteTitle = e.parentNode.parentNode.childNodes[5].textContent;
    var userName = e.parentNode.parentNode.childNodes[3].textContent;
    var noteId = e.parentNode.parentNode.childNodes[1].textContent;
    var createDate = e.parentNode.parentNode.childNodes[7].textContent;
    console.log(createDate);
    var status = e.parentNode.parentNode.childNodes[13].textContent;
    var delegation = e.parentNode.parentNode.childNodes[9].textContent;
    var noteContent = e.getAttribute('data-note-content');
    var completionDateFormatted = e.parentNode.parentNode.querySelector('#completiondate-main').textContent;
    var completionDate = formatCompletionDateForEditModal(completionDateFormatted);
    console.log(completionDate);
    // Set the content in the modal and hidden input field
    document.getElementById('note-title-display').textContent = noteTitle;
    document.getElementById('user-name-display').textContent = userName;
    document.getElementById('noteIdToUpdate').value = noteId;
    document.getElementById('noteIdToSearch').value = noteId;
    document.getElementById('createDate-edit').textContent = formatCreatedDate(createDate);
    document.getElementById('status-edit').value = status;
    document.getElementById('completeDate-edit').value = completionDate;
    document.getElementById('noteContentTextarea').value = noteContent;

    setNoteIdToUpdate(noteId)
}
function updateDisplayedDate(inputElement) {
    var date = inputElement.value;
    
    if (date.length >= 16) {
        // Remove the seconds (last 3 characters)
        inputElement.value = date.substring(0, 16);
    }
}
function deleteNote(e) {
    var deleteForm = document.getElementById('delete-form');
    deleteForm.style.display = 'block';
    var NoteIdtodelete = e.parentNode.parentNode.childNodes[1].textContent;
    document.getElementById('NoteId').value = NoteIdtodelete;
}
function openShareUserModal() {
    if (noteIdToUpdate !== null) {
        document.getElementById('noteIdToUpdate-Share').value = noteIdToUpdate;
    }
    document.getElementById('shareUserModal').style.display = 'block';
}

function closeShareUserModal() {
    document.getElementById('shareUserModal').style.display = 'none';
}

function opensharelist() {
    document.getElementById('sharinglistmodal').style.display = 'block';
}
function closesharelist() {
    document.getElementById('sharinglistmodal').style.display = 'none';
}
function populateDelegatedDropdown() {
    console.log("function")
    const createDropdown = document.getElementById('delegatedlist');
    const editDropdown = document.getElementById('delegatedlist-edit');

    fetch('/getdelegations')
        .then(response => response.json())
        .then(names => {
            names.forEach(name => {
                const createOption = document.createElement('option');
                createOption.value = name;
                createOption.textContent = name;
                createDropdown.appendChild(createOption);
                console.log(createDropdown)

                const editOption = document.createElement('option');
                editOption.value = name;
                editOption.textContent = name;
                editDropdown.appendChild(editOption);
                console.log(editDropdown)
            });
        })
        .catch(error => console.error(error));
}

// Call the function to populate the "Delegated to" dropdown when the page loads
function formatCreatedDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
    const formattedDate = new Date(dateString).toLocaleDateString('en-US', options);
    return formattedDate;
}
function formatCompletionDateForEditModal(dateString) {
    // Convert the date to the desired format
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');

    // Return the formatted date suitable for the input field
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
    // Function to update highlighting
    function updateHighlighting() {
        // Get the search value from the search input
        var searchValue = document.querySelector('form[name="searchinnote"] input[name="search"]').value;
        console.log(searchValue)
        
        // Get all elements in the /update form that need highlighting
        var elementsToHighlight = document.querySelectorAll('.highlightable');
        console.log(elementsToHighlight)

        // Remove existing highlighting
        elementsToHighlight.forEach(function (element) {
            element.classList.remove('highlight');
        });

        // Highlight elements matching the search value
        elementsToHighlight.forEach(function (element) {
            var elementValue = element.value || element.textContent; // Get the value of the element
            if (elementValue.includes(searchValue)) {
                element.classList.add('highlight');
            }
        });
    }

    function populateSharelist() {
    console.log("function");
    const userSharelistcreate = document.getElementById('user-share-create');
    const userSharelist = document.getElementById('user-shareoptions');
    const customListSharelist = document.getElementById('custom-list-shareoptions');

    // Create two separate promises for fetching user and custom sharing lists
    const userPromise = fetch('/getsharelist')
        .then(response => response.json())
        .then(users => {
            users.forEach(user => {
                const createcheckbox = document.createElement('input');
                createcheckbox.value = user.id; // Access the 'id' property
                createcheckbox.type = "checkbox";
                createcheckbox.name = "user";
                const createlabel = document.createElement('label');
                createlabel.textContent = user.name; // Access the 'name' property
                userSharelist.appendChild(createcheckbox);
                userSharelist.appendChild(createlabel);
                userSharelist.appendChild(document.createElement('br'));

                userSharelistcreate.appendChild(createcheckbox.cloneNode(true)); // Clone the checkbox for user-share-create
                userSharelistcreate.appendChild(createlabel.cloneNode(true)); // Clone the label for user-share-create
                userSharelistcreate.appendChild(document.createElement('br'));
            });
        })
        .catch(error => console.error(error));

    const customListPromise = fetch('/getcustomsharinglists')
        .then(response => response.json())
        .then(lists => {
            lists.forEach(list => {
                console.log(list.listID)
                const createcheckbox = document.createElement('input');
                createcheckbox.value = list.listID;
                createcheckbox.type = "checkbox";
                createcheckbox.name = "customlist"; // Use a different name for custom lists
                console.log(createcheckbox)
                const createlabel = document.createElement('label');
                createlabel.textContent = list.listname; // Access the 'listname' property
                console.log(createlabel)
                customListSharelist.appendChild(createcheckbox);
                customListSharelist.appendChild(createlabel);
                customListSharelist.appendChild(document.createElement('br'));
            });
        })
        .catch(error => console.error(error));

    // Use Promise.all to wait for both promises to complete
    Promise.all([userPromise, customListPromise]).then(() => {
    });
}


document.addEventListener('DOMContentLoaded', function () {
    populateDelegatedDropdown();
    populateSharelist();
    document.querySelector('form[name="searchinnote"] button[type="button"]').addEventListener('click', function(event) {
        event.preventDefault(); // Prevent form submission or redirection
        updateHighlighting();
    });
});
</script>
</body>
</html>